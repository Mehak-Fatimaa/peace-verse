<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PeaceVerse - Your Verse</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap');

        body {
          margin: 40px 20px 40px;
          font-family: 'Nunito', sans-serif;
          background: #f5f1fa;
          display: flex;
          flex-direction: column;
          align-items: center;
          min-height: 100vh;
          color: #4a4a4a;
        }

        .card {
          background: white;
          border-radius: 20px;
          padding: 28px 30px;
          max-width: 580px;
          box-shadow: 0 6px 35px rgb(193 175 254 / 0.24);
          width: 100%;
        }
        .mood-info {
          font-weight: 700;
          margin-bottom: 18px;
          font-size: 1rem;
          display: flex;
          align-items: center;
          gap: 8px;
        }
        .sentiment-info {
          font-weight: 700;
          margin-bottom: 20px;
          font-size: 1rem;
          display: flex;
          align-items: center;
          gap: 6px;
        }
        .sentiment-positive { color: #56c870; }
        .sentiment-negative { color: #f46a6a; }
        .sentiment-neutral { color: #9f9f9f; }

        .verse-section {
          background: #f8f6ff;
          border-radius: 14px;
          padding: 24px 22px;
          font-family: 'Scheherazade', serif;
          box-shadow: inset 0 0 30px rgb(183 139 244 / 0.15);
        }

        .arabic-text {
          font-size: 2rem;
          line-height: 1.3;
          text-align: right;
          margin-bottom: 20px;
          color: #4d3ea6;
        }
        .translation-text {
          color: #56479b;
          font-weight: 500;
          font-size: 1rem;
          line-height: 1.4;
        }

        .footer-text {
          text-align: center;
          font-weight: 500;
          color: #f5b941;
          margin: 25px 0 15px;
          font-size: 1rem;
        }

        button.share-more {
          background: linear-gradient(90deg, #f5ce55, #f4a550);
          padding: 14px 0;
          border-radius: 38px;
          border: none;
          font-weight: 700;
          font-size: 1.1rem;
          width: 100%;
          max-width: 580px;
          color: white;
          cursor: pointer;
          box-shadow: 0 8px 28px rgb(245 206 85 / 0.65);
          transition: filter 0.3s ease;
          margin-bottom: 10px;
        }
        button.share-more:hover {
          filter: brightness(1.1);
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Scheherazade&display=swap" rel="stylesheet" />
</head>
<body>
<div class="card" role="main" aria-live="polite">
    <div class="mood-info">
        <span aria-label="Mood icon" role="img">‚ô°</span>
        <div>
            <small>Your Mood</small><br />
            <strong id="moodValue">-</strong>
        </div>
    </div>

    <div class="sentiment-info" id="sentimentInfo">
        <span aria-label="Sparkles" role="img">‚ú®</span>
        <div>
            <small>Detected Sentiment</small><br />
            <strong id="sentimentText" class="">-</strong>
        </div>
    </div>

    <div style="margin-bottom:10px; font-weight:600; color:#7a5df5; cursor:pointer;" id="quranVerseLabel">
        üìñ Quranic Verse
    </div>

    <div class="verse-section">
        <p class="arabic-text" id="arabicVerse">...</p>
        <p class="translation-text" id="translationVerse">...</p>
    </div>

    <p class="footer-text">Your feelings matter <span aria-label="Heart" role="img">‚ù§Ô∏è</span></p>

    <button class="share-more" id="shareMoreBtn" aria-label="Do you want to share more feelings?">
        Do you want to share more feelings? üì©
    </button>

    <button class="share-more" id="saveVerseBtn" aria-label="Save this verse">
        Save Verse üíæ
    </button>
</div>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        const verseDataRaw = sessionStorage.getItem('verseData');
        if (!verseDataRaw) {
            alert('No verse data found. Redirecting to home...');
            location.href = '/';
            return;
        }

        const verseData = JSON.parse(verseDataRaw);

        // Populate mood & verse info
        document.getElementById('moodValue').textContent = verseData.mood || '-';
        const sentimentText = document.getElementById('sentimentText');
        const sentiment = verseData.sentiment || 'neutral';

        sentimentText.textContent = sentiment.charAt(0).toUpperCase() + sentiment.slice(1);
        if (sentiment === 'positive') {
            sentimentText.className = 'sentiment-positive';
            sentimentText.innerHTML = 'üòä Positive';
        } else if (sentiment === 'negative') {
            sentimentText.className = 'sentiment-negative';
            sentimentText.innerHTML = 'üòî Negative';
        } else {
            sentimentText.className = 'sentiment-neutral';
            sentimentText.innerHTML = 'üòê Neutral';
        }

        document.getElementById('arabicVerse').textContent = verseData.arabicVerse || '';
        document.getElementById('translationVerse').textContent = verseData.translation || '';

        // Remove temporary verse data after showing
        sessionStorage.removeItem('verseData');
    });

    document.getElementById('shareMoreBtn').addEventListener('click', () => {
        window.location.href = "/";
    });

    document.getElementById('saveVerseBtn').addEventListener('click', async () => {
        const loggedIn = sessionStorage.getItem('loggedInUser');

        // Prepare verse data
        const verseData = {
            mood: document.getElementById('moodValue').textContent.trim(),
            sentiment: document.getElementById('sentimentText').textContent.trim(),
            arabicVerse: document.getElementById('arabicVerse').textContent.trim(),
            translation: document.getElementById('translationVerse').textContent.trim(),
            surah: document.getElementById('surahValue')?.textContent || "1",
            ayah: document.getElementById('ayahValue')?.textContent || "1"
        };

        if (!loggedIn) {
            // Save temporarily for after-login save
            sessionStorage.setItem('pendingSaveVerse', JSON.stringify(verseData));
            window.location.href = '/register.html';
            return;
        }

        // Logged in ‚Üí directly save
        await saveVerse(verseData);
    });

async function saveVerse(verseData) {
    try {
        const rawUser = sessionStorage.getItem('loggedInUser');
        let loggedInUser;

        try {
            loggedInUser = JSON.parse(rawUser);
        } catch (e) {
            console.warn("Invalid loggedInUser found:", rawUser);
            sessionStorage.removeItem('loggedInUser');
            alert("Your session expired or data was invalid. Please log in again.");
            window.location.href = "/register.html";
            return;
        }

        const username = loggedInUser?.username; // üëà Add this
        if (!username) {
            alert("User not found. Please log in again.");
            window.location.href = "/register.html";
            return;
        }

        verseData.username = username; // üëà Add username to verseData

        const response = await fetch(`/api/saveVerse`, { // üëà remove ?userId=...
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(verseData),
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || "Failed to save verse");
        }

        alert("Verse saved successfully!");
    } catch (err) {
        alert("Error saving verse.");
        console.error("Verse save error:", err);
    }
}

</script>
</body>
</html>